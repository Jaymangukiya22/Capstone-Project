{
  "title": "PostgreSQL (Prometheus Exporter)",
  "uid": "postgresql-prometheus",
  "tags": ["postgres", "prometheus"],
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "10s",
  "panels": [
    {"type": "row", "title": "Connections", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0}},
    {
      "type": "stat",
      "title": "Total Connections",
      "gridPos": {"h": 4, "w": 6, "x": 0, "y": 1},
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {"expr": "sum(pg_stat_activity_count{job=\"postgresql\"})", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "short"}},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"], "values": false}}
    },
    {
      "type": "stat",
      "title": "Active Connections",
      "gridPos": {"h": 4, "w": 6, "x": 6, "y": 1},
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {"expr": "sum(pg_stat_activity_count{job=\"postgresql\", state=\"active\"})", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "short"}}
    },
    {
      "type": "gauge",
      "title": "Connections Used %",
      "gridPos": {"h": 6, "w": 6, "x": 12, "y": 1},
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {"expr": "sum(pg_stat_activity_count{job=\"postgresql\"}) / max(pg_settings_max_connections{job=\"postgresql\"})", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "percentunit"}},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"]}}
    },

    {"type": "row", "title": "Throughput & Latency", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 7}},
    {
      "type": "stat",
      "title": "Transactions/sec",
      "gridPos": {"h": 4, "w": 6, "x": 0, "y": 8},
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {"expr": "sum(rate(pg_stat_database_xact_commit{job=\"postgresql\"}[5m])) + sum(rate(pg_stat_database_xact_rollback{job=\"postgresql\"}[5m]))", "refId": "A"}
      ]
    },
    {
      "type": "stat",
      "title": "Queries/sec",
      "gridPos": {"h": 4, "w": 6, "x": 6, "y": 8},
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {"expr": "sum(rate(pg_stat_statements_calls{job=\"postgresql\"}[5m]))", "refId": "A"}
      ]
    },
    {
      "type": "stat",
      "title": "Avg Query Time (ms)",
      "gridPos": {"h": 4, "w": 6, "x": 12, "y": 8},
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {"expr": "(sum(rate(pg_stat_statements_total_time_seconds{job=\"postgresql\"}[5m])) / sum(rate(pg_stat_statements_calls{job=\"postgresql\"}[5m]))) * 1000", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "ms"}}
    },

    {"type": "row", "title": "Sizes & Cache", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 12}},
    {
      "type": "timeseries",
      "title": "Total Database Size",
      "gridPos": {"h": 6, "w": 12, "x": 0, "y": 13},
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {"expr": "sum(pg_database_size_bytes{job=\"postgresql\"})", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "bytes"}}
    },
    {
      "type": "gauge",
      "title": "Shared Buffer Hit Ratio %",
      "gridPos": {"h": 6, "w": 12, "x": 12, "y": 13},
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {"expr": "(sum(rate(pg_stat_database_blks_hit{job=\"postgresql\"}[5m])) / (sum(rate(pg_stat_database_blks_hit{job=\"postgresql\"}[5m])) + sum(rate(pg_stat_database_blks_read{job=\"postgresql\"}[5m])))) * 100", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "percent"}}
    },

    {"type": "row", "title": "Tuples Ops/sec", "gridPos": {"h": 1, "w": 24, "x": 0, "y": 19}},
    {
      "type": "timeseries",
      "title": "Inserts/Updates/Deletes per sec",
      "gridPos": {"h": 7, "w": 24, "x": 0, "y": 20},
      "datasource": {"type": "prometheus", "uid": "prometheus"},
      "targets": [
        {"expr": "sum(rate(pg_stat_user_tables_n_tup_ins{job=\"postgresql\"}[5m]))", "refId": "A", "legendFormat": "inserts/s"},
        {"expr": "sum(rate(pg_stat_user_tables_n_tup_upd{job=\"postgresql\"}[5m]))", "refId": "B", "legendFormat": "updates/s"},
        {"expr": "sum(rate(pg_stat_user_tables_n_tup_del{job=\"postgresql\"}[5m]))", "refId": "C", "legendFormat": "deletes/s"}
      ]
    }
  ]
}
